# Telegram 群聊监听系统 - 项目总结

## 📋 项目概述

一个完整的基于 Python + FastAPI + Telethon 的在线 Telegram 消息监听和自动回复系统，支持多进程架构和网页界面操作。

## ✅ 已完成的功能

### 1. 网页配置（步骤 0）
- ✅ 在浏览器中直接配置 API 凭证
- ✅ 显示获取凭证的详细步骤
- ✅ 自动保存配置到 `api_config.json`
- ✅ 首次使用无需手动创建配置文件

### 2. Telegram 登录（步骤 1-2）
- ✅ 手机号登录
- ✅ 验证码验证
- ✅ 二次密码支持
- ✅ 密码错误时支持重新输入
- ✅ 友好的错误提示

### 3. 群聊选择（步骤 3）
- ✅ 获取所有群聊列表
- ✅ 显示群成员数量
- ✅ 点击选择要监听的群

### 4. 监听配置（步骤 4）
- ✅ 关键字匹配（多个关键字）
- ✅ 自动回复消息列表（多条消息）
- ✅ 消息发送间隔设置

### 5. 消息监听和自动回复（步骤 5）
- ✅ 实时监听群聊新消息
- ✅ 关键字匹配触发
- ✅ 按顺序发送回复消息
- ✅ 可设置发送间隔
- ✅ 实时显示日志
- ✅ 支持停止监听

## 🏗️ 技术架构

### 多进程架构
```
主进程 (FastAPI)         工作进程 (Telegram)
     |                           |
     |---> 命令队列 ------------>|
     |                           |
     |<--- 响应队列 <------------|
     |                           |
     |<--- 结果队列 <------------|
```

### 进程通信机制
- **命令队列**: 主进程 → 工作进程
- **响应队列**: 工作进程 → 主进程
- **结果队列**: 工作进程 → 主进程（用于实时日志）

### 响应类型过滤
每个 API 只接收对应类型的响应，避免响应混乱：
- `verify_response` - 登录验证响应
- `dialogs_response` - 群聊列表响应
- `monitor_started` - 监听启动响应
- 等等...

## 📁 项目结构

```
tg/
├── main.py                 # 主程序入口
├── pyproject.toml          # UV 项目配置
├── requirements.txt        # pip 依赖列表
├── README.md              # 项目文档
├── SETUP.md               # 配置指南
├── api_config.json        # API 凭证（自动生成）
├── app/
│   ├── __init__.py
│   ├── api.py             # FastAPI 路由
│   ├── telegram_client.py # Telegram 客户端
│   ├── process_manager.py # 进程管理器
│   └── templates/
│       └── index.html     # 前端页面
└── telegram_session.session  # Telegram 会话（自动生成）
```

## 🚀 使用方法

### 安装依赖

#### 使用 UV（推荐）
```bash
uv sync
```

#### 使用 pip
```bash
pip install -r requirements.txt
```

### 启动服务

```bash
uv run python main.py
```

或

```bash
python main.py
```

### 使用流程

1. 打开浏览器访问 http://localhost:8000
2. 配置 API 凭证（首次使用）
3. 输入手机号并获取验证码
4. 输入验证码和二次密码（如果需要）
5. 选择要监听的群聊
6. 配置关键字和自动回复消息
7. 开始监听

## ⚠️ 注意事项

### 验证码限制
- 如果验证码选项已用尽，需要等待 **15-30 分钟** 后再试
- 这是 Telegram 为防止滥用而设置的限制

### 二次密码
- 如果启用了两步验证，需要输入二次密码
- 密码错误时可以重新输入，无需重新获取验证码

### 使用建议
- 合理设置消息发送间隔（建议至少 1 秒）
- 避免频繁发送消息，以防被限制
- 注意遵守 Telegram 的使用条款
- 不要用于垃圾消息或骚扰他人

## 🔧 技术细节

### 使用的库
- **FastAPI**: Web 框架
- **Telethon**: Telegram 客户端库
- **Uvicorn**: ASGI 服务器
- **multiprocessing**: 进程管理
- **Queue**: 进程间通信

### 关键技术
- **多进程架构**: 主进程和 TG 进程分离
- **队列通信**: 使用 Queue 实现进程间通信
- **事件驱动**: 使用 Telethon 事件监听新消息
- **响应过滤**: 避免响应队列混乱
- **状态管理**: 支持二次密码的状态跟踪

### 安全性
- API 凭证存储在本地文件
- 自动加入 `.gitignore`
- 支持 HTTPS（生产环境建议）

## 📝 待优化项

1. **会话持久化**: 支持会话文件管理
2. **多群监听**: 同时监听多个群
3. **消息模板**: 支持变量替换
4. **历史记录**: 保存监听历史
5. **用户管理**: 多用户支持
6. **HTTPS 支持**: 生产环境部署

## 🎉 总结

项目已完全实现所有核心功能，包括：
- ✅ 网页配置 API 凭证
- ✅ Telegram 登录和验证
- ✅ 群聊选择
- ✅ 关键字监听
- ✅ 自动回复
- ✅ 多进程架构
- ✅ 友好的用户界面
- ✅ 完善的错误处理

系统已准备好投入使用！🎊

